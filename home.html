<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Accueil — LaClasse</title>
<style>
:root{
  --bg:linear-gradient(135deg,#6a11cb,#2575fc);
  --card:rgba(255,255,255,0.04);
  --muted:rgba(238,242,255,0.8);
  --primary:linear-gradient(90deg,#7f5af0,#6a11cb);
  --accent:#ffd369;
  --radius:12px; font-family:Inter,Arial,sans-serif;
}
body{margin:0;min-height:100vh;background:var(--bg);color:#eef2ff}
.wrap{max-width:1100px;margin:20px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:var(--accent);color:#08121a;display:flex;align-items:center;justify-content:center;font-weight:800}
.card{background:var(--card);padding:16px;border-radius:var(--radius);margin-top:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px}
.tile{padding:14px;border-radius:12px;background:rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:8px}
.btn{padding:10px 14px;border-radius:12px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.meta{color:var(--muted)}
@media(max-width:600px){ .header{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">CL</div>
        <div>
          <div style="font-size:18px;font-weight:700">LaClasse</div>
          <div class="meta">Ton espace de classe</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="adminBtn" class="btn" style="display:none;background:var(--accent);color:#08121a">Admin</button>
        <button id="logoutBtn" class="btn ghost">Se déconnecter</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:16px;font-weight:700">Bienvenue</div>
          <div id="sub" class="meta">Chargement du profil…</div>
        </div>
        <div id="profile" class="meta"></div>
      </div>

      <div class="grid">
        <div class="tile">
          <strong>Chat général</strong>
          <div class="meta">Discussion commune.</div>
          <div style="margin-top:auto"><button class="btn" onclick="location.href='general.html'">Ouvrir</button></div>
        </div>

        <div class="tile">
          <strong>Chat de ma classe</strong>
          <div class="meta">Discussion privée selon ta classe.</div>
          <div style="margin-top:auto"><button id="openMyClass" class="btn ghost">Ouvrir</button></div>
        </div>

        <div class="tile">
          <strong>Tableau des classes</strong>
          <div class="meta">Voir les listes.</div>
          <div style="margin-top:auto"><button class="btn ghost" onclick="location.href='tableau.html'">Voir</button></div>
        </div>

        <div class="tile">
          <strong>Profil</strong>
          <div id="profileBox" class="meta">—</div>
          <div style="margin-top:auto"></div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYPGjiUNLU9nzPNWVDfWMXQ7zYeE7VRtI",
  authDomain: "laclassedefou.firebaseapp.com",
  projectId: "laclassedefou",
  storageBucket: "laclassedefou.firebasestorage.app",
  messagingSenderId: "625518146786",
  appId: "1:625518146786:web:1ccbf39c23199b0dda1abb",
  measurementId: "G-DP9HJXJGTC"
};
initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const adminBtn = document.getElementById('adminBtn');
const logoutBtn = document.getElementById('logoutBtn');
const sub = document.getElementById('sub');
const profileBox = document.getElementById('profileBox');
const openMyClass = document.getElementById('openMyClass');

onAuthStateChanged(auth, async user => {
  if(!user){ location.href='login.html'; return; }
  sub.textContent = `Connecté : ${user.email}`;
  profileBox.textContent = user.displayName || user.email;

  // refresh token to get claims
  try{ await user.getIdToken(true); }catch(e){}

  try{
    const token = await user.getIdTokenResult();
    if(token.claims && token.claims.admin){
      adminBtn.style.display = 'inline-block';
      adminBtn.addEventListener('click', ()=> location.href='admin.html');
    } else adminBtn.style.display = 'none';
  }catch(e){ console.warn(e); }

  // show profile and class if available
  try{
    const uSnap = await getDoc(doc(db,'users', user.uid));
    if(uSnap.exists()){
      const data = uSnap.data();
      profileBox.innerHTML = `${data.prenom || user.displayName || ''} ${data.nom || ''}<div class="meta">Classe: ${data.classe || '—'}</div>`;
      openMyClass.onclick = ()=> {
        if(data.classe) location.href = `classe.html?class=${encodeURIComponent(data.classe)}`;
        else alert('Aucune classe assignée');
      };
    } else {
      openMyClass.onclick = ()=> alert('Aucun profil trouvé');
    }
  }catch(e){ console.warn(e); }
});

logoutBtn.addEventListener('click', ()=> signOut(auth).then(()=> location.href='login.html'));
</script>
</body>
</html>

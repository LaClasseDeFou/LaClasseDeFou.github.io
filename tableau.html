<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tableau des classes</title>
<style>
  :root{
    --bg: linear-gradient(135deg,#6a11cb,#2575fc);
    --glass: rgba(255,255,255,0.03);
    --muted: rgba(238,242,255,0.8);
    --radius:12px;
    font-family:Inter,Arial,sans-serif;
  }
  body{margin:0;background:var(--bg);color:white;-webkit-font-smoothing:antialiased}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#7f5af0,#6a11cb);cursor:pointer;color:white;font-weight:600}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:18px}
  .card{background:var(--glass);padding:14px;border-radius:12px}
  .className{font-weight:700;font-size:16px}
  .count{color:var(--muted);font-size:13px}
  .empty{color:var(--muted)}
  @media (max-width:600px){ .top{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h2 style="margin:0">Tableau des classes</h2>
        <div style="color:var(--muted)">Voir les membres. Ouvrir le chat seulement si tu appartiens à la classe (ou si tu es admin).</div>
      </div>
      <div><button class="btn" onclick="location.href='home.html'">Retour</button></div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYPGjiUNLU9nzPNWVDfWMXQ7zYeE7VRtI",
  authDomain: "laclassedefou.firebaseapp.com",
  projectId: "laclassedefou",
  storageBucket: "laclassedefou.firebasestorage.app",
  messagingSenderId: "625518146786",
  appId: "1:625518146786:web:1ccbf39c23199b0dda1abb",
  measurementId: "G-DP9HJXJGTC"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const GRID = document.getElementById('grid');
const CLASSES = [
  '6A','6B','6C','6D','6E',
  '5A','5B','5C','5D','5E',
  '4A','4B','4C','4D','4E',
  '3A','3B','3C','3D','3E'
];

function uniqueCountByUid(docs){
  const s = new Set();
  docs.forEach(d=> s.add(d.id)); // each user doc id is uid
  return s.size;
}

async function buildTable(currentUserUid, currentUserClasse, isAdmin){
  GRID.innerHTML = '<div style="color:var(--muted)">Chargement...</div>';
  try{
    const snap = await getDocs(collection(db,'users'));
    // group by classe, each doc id = uid so unique
    const byClass = {};
    snap.forEach(d => {
      const c = (d.data().classe || '').toUpperCase();
      if(!c) return;
      if(!byClass[c]) byClass[c] = [];
      byClass[c].push(d.id);
    });
    GRID.innerHTML = '';
    CLASSES.forEach(c => {
      const count = byClass[c] ? new Set(byClass[c]).size : 0;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div class="className">${c}</div><div class="count">${count ? count + ' élèves' : '<span class="empty">0 élèves</span>'}</div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" data-class="${c}" data-action="members">Voir membres</button>
          <button class="btn" data-class="${c}" data-action="open" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">Ouvrir chat</button>
        </div>`;
      GRID.appendChild(card);
    });
    // listeners
    Array.from(document.querySelectorAll('[data-action]')).forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const cls = btn.getAttribute('data-class');
        const action = btn.getAttribute('data-action');
        if(action === 'members'){
          // open classe.html in view-members mode parameter
          location.href = `classe.html?class=${encodeURIComponent(cls)}&view=members`;
          return;
        }
        if(action === 'open'){
          // if user belongs to this class or admin -> open chat
          if(isAdmin || currentUserClasse === cls){
            location.href = `classe.html?class=${encodeURIComponent(cls)}`;
          } else {
            alert("Tu ne peux pas ouvrir le chat de cette classe. Tu peux uniquement voir la liste des membres.");
            location.href = `classe.html?class=${encodeURIComponent(cls)}&view=members`;
          }
        }
      });
    });
  }catch(e){
    console.error(e);
    GRID.innerHTML = `<div style="color:var(--muted)">Erreur en chargeant les classes. Voir console.</div>`;
  }
}

// check auth and build table with user info
onAuthStateChanged(auth, async user => {
  if(!user) { location.href='login.html'; return; }
  let classe = '';
  let isAdmin = false;
  try{
    const uRef = (await import('https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js')).doc(db,'users',user.uid);
    const uSnap = await (await import('https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js')).getDoc(uRef);
    if(uSnap && uSnap.exists()) classe = (uSnap.data().classe||'').toUpperCase();
  }catch(e){ console.warn(e); }
  try{ const token = await user.getIdTokenResult(); isAdmin = !!(token.claims && token.claims.admin); }catch(e){}
  buildTable(user.uid, classe, isAdmin);
});
</script>
</body>
</html>

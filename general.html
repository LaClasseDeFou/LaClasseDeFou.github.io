<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat de la classe</title>
  <style>
    :root{ --bg:linear-gradient(135deg,#6a11cb,#2575fc); --muted:#cbd5f6;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial;background:var(--bg);color:white}
    .wrap{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;}
    .card{width:100%; max-width:900px; background:rgba(255,255,255,0.04); border-radius:12px; padding:18px;}
    .messages{height:460px; overflow:auto; background:rgba(0,0,0,0.12); padding:12px; border-radius:10px; margin-bottom:12px}
    .msg{margin-bottom:10px; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.03)}
    .me{background:linear-gradient(90deg,#7f5af0,#6a11cb); color:white}
    .meta{font-size:12px;color:var(--muted); margin-bottom:6px}
    .composer{display:flex; gap:8px}
    .input{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:white}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#7f5af0,#6a11cb);cursor:pointer;color:white}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div>
          <div style="font-size:18px">Chat général — ta classe</div>
          <div id="classeLabel" style="color:var(--muted);font-size:13px">Chargement classe…</div>
        </div>
        <div><button onclick="location.href='home.html'" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">Retour</button></div>
      </div>

      <div id="messages" class="messages"></div>

      <div style="display:flex; align-items:center; gap:12px;">
        <input id="textInput" class="input" placeholder="Écrire un message..." />
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYPGjiUNLU9nzPNWVDfWMXQ7zYeE7VRtI",
    authDomain: "laclassedefou.firebaseapp.com",
    projectId: "laclassedefou",
    storageBucket: "laclassedefou.firebasestorage.app",
    messagingSenderId: "625518146786",
    appId: "1:625518146786:web:1ccbf39c23199b0dda1abb",
    measurementId: "G-DP9HJXJGTC"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  const classeLabel = document.getElementById('classeLabel');

  let unsubscribe = null;
  let myClasse = '';

  onAuthStateChanged(auth, async user => {
    if(!user){ location.href='login.html'; return; }
    if(!user.emailVerified){ await signOut(auth); location.href='login.html'; return; }
    const d = await getDoc(doc(db,'users', user.uid));
    myClasse = d.exists() ? (d.data().classe || '') : '';
    classeLabel.innerText = myClasse ? `Classe : ${myClasse}` : 'Aucune classe définie';
    if(!myClasse){ messagesEl.innerHTML = '<div style="color:#ffd369">Tu n\\'as pas de classe. Contacte l\\'admin.</div>'; return; }

    const q = query(collection(db,'messages'), where('classe','==',myClasse), orderBy('createdAt'));
    unsubscribe = onSnapshot(q, snap => {
      messagesEl.innerHTML = '';
      snap.forEach(docSnap => {
        const m = docSnap.data();
        const el = document.createElement('div');
        el.className = 'msg' + (m.uid === user.uid ? ' me' : '');
        const meta = document.createElement('div'); meta.className = 'meta';
        const name = m.displayName || m.pseudo || m.email || 'Anonyme';
        const time = m.createdAt && m.createdAt.toDate ? new Date(m.createdAt.toDate()).toLocaleString() : '';
        meta.innerText = `${name} • ${time}`;
        const body = document.createElement('div'); body.innerText = m.text;
        el.appendChild(meta); el.appendChild(body);
        messagesEl.appendChild(el);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  });

  sendBtn.addEventListener('click', async ()=>{
    const txt = (textInput.value || '').trim();
    if(!txt) return;
    const user = auth.currentUser;
    if(!user){ alert('Reconnecte-toi'); return; }
    if(!myClasse){ alert('Pas de classe'); return; }
    try{
      await addDoc(collection(db,'messages'), {
        text: txt,
        uid: user.uid,
        displayName: user.displayName || '',
        email: user.email || '',
        pseudo: '',
        classe: myClasse,
        createdAt: serverTimestamp()
      });
      textInput.value = '';
    }catch(e){ console.error(e); alert('Erreur'); }
  });

  textInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendBtn.click(); });
</script>
</body>
</html>

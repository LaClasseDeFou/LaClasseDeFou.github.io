<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat de la classe</title>
  <style>
    :root{ --bg: linear-gradient(135deg,#6a11cb,#2575fc); --card:#0b1220aa; --muted:#cbd5f6; --accent:#ffd369; --radius:12px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial;background:var(--bg);color:white;-webkit-font-smoothing:antialiased}
    .wrap{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;}
    .card{width:100%; max-width:900px; background:rgba(255,255,255,0.04); border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.35)}
    .top{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px}
    .title{font-size:18px}
    .lead{color:var(--muted); font-size:13px}
    .messages{height:460px; overflow:auto; background:rgba(0,0,0,0.12); padding:12px; border-radius:10px; margin-bottom:12px}
    .msg{margin-bottom:10px; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.03)}
    .me{background:linear-gradient(90deg,#7f5af0,#6a11cb); color:white}
    .meta{font-size:12px;color:var(--muted); margin-bottom:6px}
    .composer{display:flex; gap:8px}
    .input{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:white}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#7f5af0,#6a11cb);cursor:pointer;color:white}
    .hint{font-size:13px;color:var(--muted); margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="title">Chat général — ta classe</div>
          <div id="classeLabel" class="lead">Chargement classe…</div>
        </div>
        <div>
          <button id="backBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:white">Retour</button>
        </div>
      </div>

      <div id="messages" class="messages"></div>

      <div style="display:flex; align-items:center; gap:12px;">
        <div class="composer" style="flex:1">
          <input id="textInput" class="input" placeholder="Écrire un message..." />
        </div>
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>

      <div class="hint">Messages publics à toute la classe. Respecte les règles.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYPGjiUNLU9nzPNWVDfWMXQ7zYeE7VRtI",
      authDomain: "laclassedefou.firebaseapp.com",
      projectId: "laclassedefou",
      storageBucket: "laclassedefou.firebasestorage.app",
      messagingSenderId: "625518146786",
      appId: "1:625518146786:web:1ccbf39c23199b0dda1abb",
      measurementId: "G-DP9HJXJGTC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const messagesEl = document.getElementById('messages');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    const classeLabel = document.getElementById('classeLabel');
    const backBtn = document.getElementById('backBtn');

    let unsubscribe = null;
    let myClasse = '';

    backBtn.addEventListener('click', ()=> window.location.href = 'home.html');

    onAuthStateChanged(auth, async user => {
      if(!user){ window.location.href = 'login.html'; return; }
      if(!user.emailVerified){ await signOut(auth); window.location.href='login.html'; return; }

      // read user doc to get classe
      const udoc = await getDoc(doc(db,'users', user.uid));
      const classe = udoc.exists() ? (udoc.data().classe || '') : '';
      myClasse = classe;
      classeLabel.innerText = classe ? `Classe : ${classe}` : 'Aucune classe définie';
      if(!classe){ messagesEl.innerHTML = '<div style="color:#ffd369">Tu n\'as pas de classe. Va dans le tableau et choisie ta classe.</div>'; return; }

      // subscribe to messages of this class
      const q = query(collection(db,'messages'), where('classe','==',classe), orderBy('createdAt'));
      unsubscribe = onSnapshot(q, snap => {
        messagesEl.innerHTML = '';
        snap.forEach(docSnap => {
          const m = docSnap.data();
          const el = document.createElement('div');
          el.className = 'msg' + (m.uid === user.uid ? ' me' : '');
          const meta = document.createElement('div');
          meta.className = 'meta';
          const name = m.displayName || m.pseudo || m.email || 'Anonyme';
          const time = m.createdAt && m.createdAt.toDate ? new Date(m.createdAt.toDate()).toLocaleString() : '';
          meta.innerText = `${name} • ${time}`;
          const body = document.createElement('div');
          body.innerText = m.text;
          el.appendChild(meta);
          el.appendChild(body);
          messagesEl.appendChild(el);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    });

    sendBtn.addEventListener('click', async ()=>{
      const txt = (textInput.value || '').trim();
      if(!txt){ return; }
      const user = auth.currentUser;
      if(!user){ alert('Reconnecte-toi'); return; }
      if(!myClasse){ alert('Tu n\'as pas de classe définie.'); return; }
      try{
        await addDoc(collection(db,'messages'), {
          text: txt,
          uid: user.uid,
          displayName: user.displayName || '',
          email: user.email || '',
          pseudo: '', // optionnel
          classe: myClasse,
          createdAt: serverTimestamp()
        });
        textInput.value = '';
      }catch(e){ console.error(e); alert('Erreur en envoyant'); }
    });

    textInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendBtn.click(); });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat général</title>
<style>
  :root{
    --bg:linear-gradient(135deg,#6a11cb,#2575fc);
    --card:rgba(255,255,255,0.04);
    --muted:rgba(238,242,255,0.8);
    --primary:linear-gradient(90deg,#7f5af0,#6a11cb);
    --radius:12px;font-family:Inter,Arial,sans-serif;
  }
  body{margin:0;min-height:100vh;background:var(--bg);color:#eef2ff}
  .wrap{max-width:1000px;margin:18px auto;padding:16px}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0}
  .card{background:var(--card);padding:16px;border-radius:var(--radius)}
  .messages{overflow-y:auto;max-height:420px;padding:12px;display:flex;flex-direction:column;gap:10px;border-radius:10px;background:rgba(0,0,0,0.06)}
  .msg{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .meta{font-size:13px;color:var(--muted);margin-bottom:6px}
  .composer{display:flex;gap:8px;margin-top:12px}
  .input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--primary);color:white;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div><h1>Chat général</h1><div class="meta">Discussion pour toute la classe</div></div>
      <div>
        <button class="btn ghost" onclick="location.href='home.html'">Retour</button>
      </div>
    </div>

    <div class="card">
      <div id="messages" class="messages" aria-live="polite"></div>

      <div class="composer">
        <input id="text" class="input" placeholder="Écris ton message... (Enter pour envoyer)"/>
        <button id="send" class="btn">Envoyer</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, limit, onSnapshot, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYPGjiUNLU9nzPNWVDfWMXQ7zYeE7VRtI",
  authDomain: "laclassedefou.firebaseapp.com",
  projectId: "laclassedefou",
  storageBucket: "laclassedefou.firebasestorage.app",
  messagingSenderId: "625518146786",
  appId: "1:625518146786:web:1ccbf39c23199b0dda1abb",
  measurementId: "G-DP9HJXJGTC"
};
initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const messagesEl = document.getElementById('messages');
const textEl = document.getElementById('text');
const sendBtn = document.getElementById('send');

// blacklist (liste en minuscules, sans accents)
const BLACKLIST = ['connard','merde','putain','sale','nique'];

// masque les mots en comparant tokens normalisés (retient la ponctuation)
function maskBadWords(original){
  // remplace chaque séquence de lettres (unicode) en testant la version "normalisée"
  return original.replace(/\p{L}+/gu, (token)=>{
    const norm = token.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    return BLACKLIST.includes(norm) ? '#'.repeat(token.length) : token;
  });
}

// récupère et affiche 100 derniers messages (limit + orderBy desc puis reverse)
onAuthStateChanged(auth, async user => {
  if(!user){ location.href='login.html'; return; }

  const q = query(collection(db,'general'), orderBy('createdAt','desc'), limit(100));
  onSnapshot(q, snap => {
    messagesEl.innerHTML = '';
    // docs are desc, reverse to chronological
    const docs = snap.docs.slice().reverse();
    docs.forEach(d=>{
      const m = d.data();
      const who = m.displayName || m.prenom || m.email || 'Anonyme';
      const classe = m.classe ? ` (${m.classe})` : '';
      const time = m.createdAt && m.createdAt.toDate ? new Date(m.createdAt.toDate()).toLocaleTimeString() : '';
      const el = document.createElement('div'); el.className = 'msg';
      el.innerHTML = `<div class="meta">${escapeHtml(who)}${escapeHtml(classe)} • ${escapeHtml(time)}</div><div>${escapeHtml(m.text)}</div>`;
      messagesEl.appendChild(el);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }, err=>{
    console.error('general snapshot error', err);
    messagesEl.innerHTML = `<div style="color:#ff9b9b">Erreur lecture messages : ${escapeHtml(err.message)}</div>`;
  });
});

// send (we mask here)
async function sendMessage(){
  const raw = (textEl.value||'').trim();
  if(!raw) return;
  const user = auth.currentUser;
  if(!user) { alert('Reconnecte-toi'); return; }

  // get user's class from users/{uid}
  let classe = "";
  try{
    const uSnap = await getDoc(doc(db,'users', user.uid));
    if(uSnap.exists()) classe = uSnap.data().classe || "";
  }catch(e){ console.warn('failed to fetch user class', e); }

  const text = maskBadWords(raw);
  try{
    await addDoc(collection(db,'general'), {
      text,
      uid: user.uid,
      displayName: user.displayName || '',
      email: user.email || '',
      classe,
      createdAt: serverTimestamp()
    });
    textEl.value = '';
  }catch(e){
    console.error('send error', e);
    alert('Erreur lors de l\'envoi : ' + (e.message || e));
  }
}

sendBtn.addEventListener('click', sendMessage);
textEl.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":"&#x2F;", "`":"&#96;", "=":"&#61;"}[c]));
}
</script>
</body>
</html>
